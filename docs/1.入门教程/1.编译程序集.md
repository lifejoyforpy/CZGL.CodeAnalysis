创建一个程序域，

通过程序域你可以动态编写代码后，编译到 .dll 中。

```csharp
            CompilationBuilder compilation = CodeSyntax.CreateCompilation(@"D:\临时\dll", "Test.dll")
                .WithAutoAssembly();
```



`.WithAutoAssembly();` 可以自动引入 .dll 依赖。



你有一段这样的代码：

```csharp
using System;
    namespace MySpace
    {      
        public class Test
        {
            public string MyMethod()
            {
                Console.WriteLine(""程序集运行成功"");
                return ""测试成功"";
        }
    }
}
```

现在使用字符串存储代码：

```csharp
            string code = @"using System;
    namespace MySpace
    {      
        public class Test
        {
            public string MyMethod()
            {
                Console.WriteLine(""程序集运行成功"");
                return ""测试成功"";
        }
    }
}
";
```



创建命名空间：

```
            NamespaceBuilder space = NamespaceBuilder.FromCode(code); // 通过字符串代码生成命名空间，即一个 .cs
```



代码写入 .dll 中

```
            compilation.WithNamespace(space);                          // 写入 .dll 中
```



```
            var isSuccess = compilation.CreateDomain(out var messages);                 // 编译代码到 .dll 中
```



检查编译输出结果：

```csharp

            // 如果编译不成功，输出编译信息
            if (!isSuccess)
            {
                _ = messages.Execute(item =>
                {
                    Console.WriteLine(@$"ID:{item.Id}
严重程度:{item.Severity}     
位置：{item.Location.SourceSpan.Start}~{item.Location.SourceSpan.End}
消息:{item.Descriptor.Title}   {item}");
                });
            }

            Console.WriteLine("恭喜，编译输出 .dll 成功");
            Console.Read();
```



完整代码如下：

```csharp
using System;
using CZGL.Roslyn;

namespace ConsoleApp
{
    class Program
    {
        static void Main(string[] args)
        {
            CompilationBuilder compilation = CodeSyntax.CreateCompilation(@"D:\临时\dll", "Test.dll")
                .WithAutoAssembly();

            string code = @"using System;
    namespace MySpace
    {      
        public class Test
        {
            public string MyMethod()
            {
                Console.WriteLine(""程序集运行成功"");
                return ""测试成功"";
        }
    }
}
";
            NamespaceBuilder space = NamespaceBuilder.FromCode(code); // 通过字符串代码生成命名空间，即一个 .cs

            compilation.WithNamespace(space);                          // 写入 .dll 中

            var isSuccess = compilation.CreateDomain(out var messages);                 // 编译代码到 .dll 中

            // 如果编译不成功，输出编译信息
            if (!isSuccess)
            {
                _ = messages.Execute(item =>
                {
                    Console.WriteLine(@$"ID:{item.Id}
严重程度:{item.Severity}     
位置：{item.Location.SourceSpan.Start}~{item.Location.SourceSpan.End}
消息:{item.Descriptor.Title}   {item}");
                });
            }

            Console.WriteLine("恭喜，编译输出 .dll 成功");
            Console.Read();
        }
    }
}
```

